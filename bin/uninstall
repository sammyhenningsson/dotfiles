#!/bin/bash

ROOT_DIR=$(git rev-parse --show-toplevel)
FILES_DIR="$ROOT_DIR/files"
TARGET_DIR=${1:-$HOME}

# Strip off any trailing slashes (does not seem to be working??)
TARGET_DIR=${TARGET_DIR%%+(/)}

if [ -d "$TARGET_DIR" ]; then
  echo "Installing into '$TARGET_DIR'"
else
  >&2 echo "Target directory '$TARGET_DIR' does not exist"
  exit 1
fi

if [ $# -gt 1 ]; then
  shift
  files=$@
else
  files=$(find $FILES_DIR -maxdepth 1 -type f)
fi


for file in $files; do
  if ! git diff-index --quiet HEAD -- "$file" ; then
    echo "$file has been changed. Reset it before uninstalling.."
    exit 1
  fi

  TARGET_FILE="$TARGET_DIR/.$(basename $file)"

  # Removing the file will delete the hard link.
  rm -f $file
  # Then simple checkout the file to restore it without the link
  git co -- $file
done

