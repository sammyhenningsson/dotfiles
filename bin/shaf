#!/usr/bin/env ruby

require 'shaf/utils'
require 'shaf/command'

module Shaf
  class Script
    include Utils

    def self.run
      new.run
    end

    def run
      check_customizations
      return show_help if show_help?
      Command::Factory.create(*ARGV).call
    rescue RegistrableFactory::NotFoundError, Command::ArgumentError => e
      puts e.message, "\n"
      show_help
      exit 1
    rescue Utils::ProjectRootNotFound
      puts "This command can only be executed inside a Shaf project directory. " \
        "Please change directory and try again!"
      exit 2
    end

    def show_help
      puts "Usage: #{script_name} #{usage}"
    end

    def script_name
      File.basename $0
    end

    def usage
      Command::Factory.usage.join("\n            ")
    end

    def show_help?
      ARGV.first =~ /-h/ 
    end

    def check_customizations
      return unless project_root

      in_project_root do
        ENV['RACK_ENV'] ||= 'development'
        next unless File.exist? 'config/customize.rb'
        require 'config/customize'
      end
    end
  end
end

Shaf::Script.run
