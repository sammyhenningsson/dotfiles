#!/bin/bash -i

ROOT_DIR=$(git rev-parse --show-toplevel)
. "$ROOT_DIR/lib/common.sh"

CHECK_GIT_STATUS=0

for file in $FILES; do
  TARGET_FILE="$TARGET_DIR/.$(basename $file)"
  if [ -f "$TARGET_FILE" ]; then
    mv "$TARGET_FILE" "${TARGET_FILE}.dotfile.backup"
    ln "$file" "$TARGET_FILE"
    cp "${TARGET_FILE}.dotfile.backup" "$file"

    if [ -n "$(git status --porcelain "$file")" ]; then
      echo "Target file '$TARGET_FILE' already exist and differs against repo!"
      CHECK_GIT_STATUS=1
    fi
  else
    echo "Linking '$TARGET_FILE'"
    ln "$file" "$TARGET_FILE"
  fi
  echo $TARGET_FILE >> "${LOG_DIR}/$(basename $file)"
done

if [ $CHECK_GIT_STATUS -gt 0 ]; then
  echo ""
  git status
fi
